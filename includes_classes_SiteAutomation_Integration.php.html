<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: includes/classes/SiteAutomation/Integration.php - Sophi Plugin Developer Documentation</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">

	<link href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono|IBM+Plex+Sans:300,400|Playfair+Display:900&display=swap" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="styles-10up.css">
</head>

<body>

<div id="main">

	
    <h1 class="page-title">Source: includes/classes/SiteAutomation/Integration.php</h1>
	

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>&lt;?php
/**
 * Site Automation Integration: Hook into WP_Query or block to replace WordPress content with Sophi curated.
 *
 * @package SophiWP
 */

namespace SophiWP\SiteAutomation;

use function SophiWP\Settings\get_sophi_settings;

/**
 * Class: Integration.
 */
class Integration {
	/**
	 * Request object.
	 *
	 * @var Request $request
	 */
	private $request;

	/**
	 * Class constructor.
	 *
	 * @param Request $request Request object.
	 */
	public function __construct( $request ) {
		$this->request = $request;

		add_filter( 'posts_pre_query', [ $this, 'get_curated_posts' ], 10, 2 );
		add_filter( 'found_posts', array( $this, 'found_posts' ), 10, 2 );
	}

	/**
	 * Change the found_posts variable on WP_Query.
	 *
	 * @param int      $found_posts Number of found posts
	 * @param WP_Query $query Query object
	 * @return int Found posts.
	 */
	public function found_posts( $found_posts, $query ) {
		if ( isset( $query->sophi_curated_post_list_success ) &amp;&amp; $query->sophi_curated_post_list_success ) {
			return $query->num_posts;
		}

		return $found_posts;
	}

	/**
	 * Inject Sophi data to WP_Query.
	 *
	 * @param array|null $posts Return an array of post data to short-circuit WP's query,
	 *                          or null to allow WP to run its normal queries.
	 * @param \WP_Query  $query  The WP_Query instance (passed by reference).
	 */
	public function get_curated_posts( $posts, $query ) {
		$query_integration = get_sophi_settings( 'query_integration' );

		if ( 1 !== intval( $query_integration ) ) {
			return $posts;
		}

		$query_vars = $query->query_vars;

		if ( empty( $query_vars['sophi_curated_page'] ) || empty( $query_vars['sophi_curated_widget'] ) ) {
			return $posts;
		}

		$curated_response = $this->request->get( $query_vars['sophi_curated_page'], $query_vars['sophi_curated_widget'] );
		$request_status   = $this->request->get_status();

		if ( ! empty ( $request_status['success'] ) ) {
			$query->sophi_curated_post_list_success = true;
			$query->num_posts = count( $curated_response );

			// Determine how we should format the results  based on the fields parameter.
			$fields = $query->get( 'fields', '' );

			switch ( $fields ) {
				case 'ids':
					$new_posts = $this->format_hits_as_ids( $curated_response );
					break;

				case 'id=>parent':
					$new_posts = $this->format_hits_as_id_parents( $curated_response );
					break;

				default:
					$new_posts = $this->format_hits_as_posts( $curated_response );
					break;
			}
		}

		if ( ! empty( $new_posts ) ) {
			$posts = array_filter( $new_posts );
		}

		/**
		 * The curated post list result that is injected to WP_Query.
		 *
		 * @since 1.0.9
		 * @hook sophi_curated_post_list
		 *
		 * @param {array} $posts Post list.
		 * @param {string} $sophi_curated_page Sophi curated page param.
		 * @param {string} $sophi_curated_widget Sophi curated widget param.
		 * @param {array}  $request_status The request status, whether it was successful or not.
		 * @param {WP_Query} $query Original query.
		 *
		 * @return {array} Post list.
		 */
		return apply_filters( 'sophi_curated_post_list', $posts, $query_vars['sophi_curated_page'], $query_vars['sophi_curated_widget'], $request_status, $query );
	}

	/**
	 * Format results as an array of ID.
	 *
	 * @param array $data Response from Sophi.
	 *
	 * @return array
	 */
	private function format_hits_as_ids( $data ) {
		return array_map(
			function( $id ) {
				return intval( $id );
			},
			$data
		);
	}

	/**
	 * Format the results as objects containing id and parent id.
	 *
	 * @param array $data Response from Sophi.
	 *
	 * @return array
	 */
	private function format_hits_as_id_parents( $data ) {
		return array_map(
			function( $id ) {
				$post              = new \stdClass();
				$post->ID          = intval( $id );
				$post->post_parent = wp_get_post_parent_id( intval( $id ) );

				return $post;
			},
			$data
		);
	}

	/**
	 * Format the results as post objects.
	 *
	 * @param array $data Response from Sophi.
	 *
	 * @return array
	 */
	private function format_hits_as_posts( $data ) {
		return array_map(
			function( $id ) {
				$post = get_post( intval( $id ) );
				if ( is_a( $post, 'WP_Post' ) ) {
					return $post;
				}
			},
			$data
		);
	}
}
</code></pre>
        </article>
    </section>





    <footer>
		<a href="https://sophi.io/">Sophi.io</a> &bull;
		<a href="https://github.com/globeandmail/sophi-for-wordpress/">Sophi for WordPress on GitHub</a> &bull;
    <a href="https://wordpress.org/plugins/sophi/">Sophi on WordPress.org</a> &bull;
		<a href="https://www.sophi.io/careers/">Careers at Sophi</a>
	</footer>


</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Actions</h3><ul><li><a href="sophi_cms_tracking_result.html">sophi_cms_tracking_result</a></li><li><a href="sophi_init.html">sophi_init</a></li><li><a href="sophi_loaded.html">sophi_loaded</a></li></ul><h3>Filters</h3><ul><li><a href="sophi_amp_tracking_data.html">sophi_amp_tracking_data</a></li><li><a href="sophi_available.html">sophi_available</a></li><li><a href="sophi_bypass_curated_posts_cache.html">sophi_bypass_curated_posts_cache</a></li><li><a href="sophi_bypass_get_cache.html">sophi_bypass_get_cache</a></li><li><a href="sophi_cache_duration.html">sophi_cache_duration</a></li><li><a href="sophi_cli_per_page_limit.html">sophi_cli_per_page_limit</a></li><li><a href="sophi_cms_tracking_request_data.html">sophi_cms_tracking_request_data</a></li><li><a href="sophi_curated_post_list.html">sophi_curated_post_list</a></li><li><a href="sophi_hierarchial_taxonomy_for_breadcrumb.html">sophi_hierarchial_taxonomy_for_breadcrumb</a></li><li><a href="sophi_non_hierarchial_taxonomy_for_breadcrumb.html">sophi_non_hierarchial_taxonomy_for_breadcrumb</a></li><li><a href="sophi_page_need_tracking.html">sophi_page_need_tracking</a></li><li><a href="sophi_post_content_type.html">sophi_post_content_type</a></li><li><a href="sophi_post_data.html">sophi_post_data</a></li><li><a href="sophi_request_args.html">sophi_request_args</a></li><li><a href="sophi_request_result.html">sophi_request_result</a></li><li><a href="sophi_site_automation_block_output.html">sophi_site_automation_block_output</a></li><li><a href="sophi_supported_post_types.html">sophi_supported_post_types</a></li><li><a href="sophi_tracker_emitter_debug.html">sophi_tracker_emitter_debug</a></li><li><a href="sophi_tracking_data.html">sophi_tracking_data</a></li></ul>
</nav>

<br class="clear">

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: sophi.php - Sophi Plugin Developer Documentation</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">

	<link href="https://fonts.googleapis.com/css?family=IBM+Plex+Mono|IBM+Plex+Sans:300,400|Playfair+Display:900&display=swap" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="styles-10up.css">
</head>

<body>

<div id="main">

	
    <h1 class="page-title">Source: sophi.php</h1>
	

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>&lt;?php
/**
 * Plugin Name:       Sophi
 * Plugin URI:        https://github.com/globeandmail/sophi-for-wordpress
 * Description:       WordPress VIP-compatible plugin for the Sophi.io Site Automation service.
 * Version:           1.1.0
 * Requires at least: 5.6
 * Requires PHP:      7.4
 * Author:            10up
 * Author URI:        https://10up.com
 * License:           GPL v2 or later
 * License URI:       https://www.gnu.org/licenses/gpl-2.0.html
 * Text Domain:       sophi-wp
 *
 * @package           SophiWP
 */

// Useful global constants.
define( 'SOPHI_WP_VERSION', '1.1.0' );
define( 'SOPHI_WP_URL', plugin_dir_url( __FILE__ ) );
define( 'SOPHI_WP_PATH', plugin_dir_path( __FILE__ ) );
define( 'SOPHI_WP_INC', SOPHI_WP_PATH . 'includes/' );

// phpcs:disable WordPressVIPMinimum.Files.IncludingFile.UsingCustomConstant

// Require Composer autoloader if it exists.
if ( file_exists( SOPHI_WP_PATH . 'vendor/autoload.php' ) ) {
	require_once SOPHI_WP_PATH . 'vendor/autoload.php';
}

// Include files.
require_once SOPHI_WP_INC . 'functions/utils.php';
require_once SOPHI_WP_INC . 'functions/core.php';
require_once SOPHI_WP_INC . 'functions/settings.php';
require_once SOPHI_WP_INC . 'functions/tracking.php';
require_once SOPHI_WP_INC . 'functions/content-sync.php';
require_once SOPHI_WP_INC . 'functions/blocks.php';

// phpcs:enable WordPressVIPMinimum.Files.IncludingFile.UsingCustomConstant

// Activation/Deactivation.
register_activation_hook( __FILE__, '\SophiWP\Core\activate' );
register_deactivation_hook( __FILE__, '\SophiWP\Core\deactivate' );

add_action(
	'init',
	function() {
		/**
		 * Filter whether Sophi is available for the current site.
		 * By default, Sophi is only available for site with HTTPS enabled.
		 *
		 * @since 1.0.0
		 * @hook sophi_available
		 *
		 * @param {bool} $available Whether Sophi should be enabled.
		 *
		 * @return {bool} Whether Sophi should be enabled.
		 */
		if ( apply_filters( 'sophi_available', is_ssl() ) ) {
			// Bootstrap.
			SophiWP\Core\setup();
			SophiWP\Settings\setup();

			if ( ! SophiWP\Utils\is_configured() ) {
				return add_action( 'admin_notices', 'sophi_setup_notice' );
			}

			SophiWP\ContentSync\setup();
			SophiWP\Tracking\setup();
			SophiWP\Blocks\setup();
			( new SophiWP\SiteAutomation\Services() )->register();

			if ( defined( 'WP_CLI' ) &amp;&amp; WP_CLI ) {
				try {
					\WP_CLI::add_command( 'sophi', 'SophiWP\Command' );
				} catch ( \Exception $e ) {
					error_log( $e->getMessage() ); // phpcs:ignore
				}
			}

			/**
			 * Fires after Sophi has been loaded.
			 *
			 * @since 1.0.0
			 * @hook sophi_loaded
			 */
			do_action( 'sophi_loaded' );
		} else {
			add_action( 'admin_notices', 'sophi_https_notice' );
		}
	}
);

/**
 * Sophi HTTPS notice.
 */
function sophi_https_notice() {
	$screen = get_current_screen();
	if ( 'plugins' !== $screen->id ) {
		return;
	}
	?>
		&lt;div class="notice notice-error">
			&lt;p>&lt;?php esc_html_e( 'Sophi requires HTTPS. Please install SSL to your site and try again.', 'sophi-wp' ); ?>&lt;/p>
		&lt;/div>
	&lt;?php
}


/**
 * Sophi setup notice.
 */
function sophi_setup_notice() {
	$screen = get_current_screen();
	if ( 'plugins' !== $screen->id ) {
		return;
	}
	?>
		&lt;div class="notice notice-error">
				&lt;p>&lt;?php echo wp_kses_post( sprintf( __( 'Please set up your Sophi.io account in Settings > &lt;a href="%s">Sophi.io&lt;/a>', 'sophi-wp' ), admin_url( 'options-general.php?page=sophi' ) ) ); ?>&lt;/p>
		&lt;/div>
	&lt;?php

}

/**
 * Upgrader function for version 1.1.0
 * Deletes sophi_site_automation like options in favor of new post_meta approach.
 *
 * @param $installed string The version installed.
 */
function sophi_upgrade_1_1_0( $installed ) {
	global $wpdb;
	if ( $installed &amp;&amp; version_compare( $installed, '1.1.0', '&lt;' ) ) {

		$options = $wpdb->get_results( $wpdb->prepare( "SELECT option_name FROM $wpdb->options WHERE option_name LIKE'%s' LIMIT 1000",  '%sophi_site_automation_data%' ) );

		foreach ( $options as $option ) {
			delete_option( $option->option_name );
		}
	}
}

add_action( 'sophi_upgrade', 'sophi_upgrade_1_1_0' );

$installed = get_option( 'sophi_version' );

if ( ! $installed || version_compare( $installed, SOPHI_WP_VERSION, '&lt;' ) ) {
	/**
	 * Upgrader hook to
	 *
	 * @param string $installed The previous version reference installed.
	 */
	do_action( 'sophi_upgrade', $installed );

	update_option( 'sophi_version', SOPHI_WP_VERSION, false );
}
</code></pre>
        </article>
    </section>





    <footer>
		<a href="https://sophi.io/">Sophi.io</a> &bull;
		<a href="https://github.com/globeandmail/sophi-for-wordpress/">Sophi for WordPress on GitHub</a> &bull;
    <a href="https://wordpress.org/plugins/sophi/">Sophi on WordPress.org</a> &bull;
		<a href="https://www.sophi.io/careers/">Careers at Sophi</a>
	</footer>


</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Actions</h3><ul><li><a href="sophi_init.html">sophi_init</a></li><li><a href="sophi_loaded.html">sophi_loaded</a></li><li><a href="sophi_tracking_result.html">sophi_tracking_result</a></li></ul><h3>Filters</h3><ul><li><a href="sophi_amp_tracking_data.html">sophi_amp_tracking_data</a></li><li><a href="sophi_available.html">sophi_available</a></li><li><a href="sophi_bypass_get_cache.html">sophi_bypass_get_cache</a></li><li><a href="sophi_cli_per_page_limit.html">sophi_cli_per_page_limit</a></li><li><a href="sophi_curated_post_list.html">sophi_curated_post_list</a></li><li><a href="sophi_hierarchial_taxonomy_for_breadcrumb.html">sophi_hierarchial_taxonomy_for_breadcrumb</a></li><li><a href="sophi_non_hierarchial_taxonomy_for_breadcrumb.html">sophi_non_hierarchial_taxonomy_for_breadcrumb</a></li><li><a href="sophi_page_need_tracking.html">sophi_page_need_tracking</a></li><li><a href="sophi_post_content_type.html">sophi_post_content_type</a></li><li><a href="sophi_post_data.html">sophi_post_data</a></li><li><a href="sophi_request_args.html">sophi_request_args</a></li><li><a href="sophi_request_result.html">sophi_request_result</a></li><li><a href="sophi_site_automation_block_output.html">sophi_site_automation_block_output</a></li><li><a href="sophi_supported_post_types.html">sophi_supported_post_types</a></li><li><a href="sophi_tracker_emitter_debug.html">sophi_tracker_emitter_debug</a></li><li><a href="sophi_tracking_data.html">sophi_tracking_data</a></li></ul>
</nav>

<br class="clear">

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
